<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Steganography Web App</title>
  <link rel="stylesheet" href="/static/style.css">
  <script src="/static/progress.js"></script>
  <script src="/static/stego.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
<div class="main-wrap">
  <div class="theme-toggle">
    <button type="button" onclick="toggleTheme()" aria-label="Toggle dark or light mode">
      <span id="themeIcon">ğŸŒ™</span> Toggle Theme
    </button>
  </div>
  <h1><span class="logo-emoji">ğŸ•µï¸</span> Secret Message Hider</h1>
  <ul class="user-caution" tabindex="0">
    <li><b>PNG is secure for hidden messages. JPEG is NOT safe.</b></li>
    <li>Never resave/modify the stego image outside this app.</li>
    <li>Download and decode using the exact output file from this app.</li>
    <li>Image size dictates hidden message limit.</li>
    <li>If decode fails, double-check image, password, and format.</li>
  </ul>
  <div class="container">

    <!-- ENCODE: -->
    <form method="POST" action="/encode" enctype="multipart/form-data" class="form-box glassy" id="encodeForm"
          aria-label="Hide a secret message" role="region" tabindex="0" onsubmit="return validateEncode();">
      <h2><span class="icon-btn">ğŸ¨</span> Hide a message</h2>
      <div class="dropzone" id="encodeDrop" aria-label="Drop PNG image here or click to select.">Drag &amp; drop a PNG here or click to browse.</div>
      <input type="file" id="encodeFile" name="image" style="display:none" required accept="image/png,image/jpeg"
             onchange="handleFileInput(this,'encodeDrop'); updateCapacity();">
      <label for="encodeMessage">Message:</label>
      <textarea name="message" id="encodeMessage" placeholder="Type your secret..." aria-label="Secret message" required oninput="updateCapacity();"></textarea>
      <div id="capacity-status" class="capacity-bar"></div>
      <label>Or hide a small file:</label>
      <input type="file" name="hide_file" id="hideFile" aria-label="File to hide" accept="*/*">
      <label for="encodePassword">Password:</label>
      <input type="password" name="password" id="encodePassword" placeholder="Choose a password" aria-label="Encryption password" required>
      <button type="submit"><span class="icon-btn">ğŸ›¡ï¸</span> Encode & Download</button>
      <div class="progress-area" id="encode-progress" style="display:none;">
        <div class="progress-bar"><div id="encodeProgressBarAnim"></div></div>
        <span id="encodeProgressText">0%</span>
        <div id="encodeAfterMsg" class="after-msg"></div>
      </div>
      {% if enc_msg and (not step_state or step_state.get('encode')) %}
        <div class="below-status {{enc_status}}">{{ enc_msg }}</div>
        {% if enc_points %}
          <button type="button" class="details-toggle" onclick="toggleDetails('enc-details')">Show/hide encode details</button>
          <div class="points-panel" id="enc-details" style="display:none;">
            <div>Image: {{enc_points.dimension}} | Capacity: {{enc_points.image_bits}} bits</div>
            <div>Message: {{enc_points.msg_len}} chars / {{enc_points.msg_bits}} bits</div>
            {% if enc_points.bits_written is defined %}
              <div>Bits written: {{enc_points.bits_written}} | Marker used: <b>yes</b></div>
            {% endif %}
            <div>Status: <b>{{enc_points.status}}</b></div>
          </div>
        {% endif %}
      {% endif %}
      {% if preview_img %}
      <div class="preview-section" aria-label="Preview encoded image">
        <img src="{{ preview_img }}" style="max-width:100%;max-height:220px;border:2px solid #c9e9fa;" alt="Stego image preview">
        <a href="{{ preview_img }}" download="{{ preview_fn }}" class="preview-download-btn" aria-label="Download stego image">â¬‡ï¸ Download Stego Image</a>
        {% if preview_hash %}
          <div class="hash-panel">SHA256: <code>{{preview_hash}}</code></div>
        {% endif %}
      </div>
      {% endif %}
    </form>

    <!-- DECODE: -->
    <form method="POST" action="/decode" enctype="multipart/form-data" class="form-box glassy" id="decodeForm"
          aria-label="Reveal a hidden message from image" role="region" tabindex="0" onsubmit="return validateDecode();">
      <h2><span class="icon-btn">ğŸ–¼ï¸</span> Reveal a message</h2>
      <div class="dropzone" id="decodeDrop" aria-label="Drop PNG here or click to select.">Drop a PNG here or click to browse.</div>
      <input type="file" id="decodeFile" name="stego_image" style="display:none" required accept="image/png,image/jpeg"
             onchange="handleFileInput(this,'decodeDrop');">
      <label for="decodePassword">Password:</label>
      <input type="password" name="password" id="decodePassword" placeholder="Enter password" aria-label="Decryption password" required>
      <button type="submit"><span class="icon-btn">ğŸ”</span> Decode</button>
      <div class="progress-area" id="decode-progress" style="display:none;">
        <div class="progress-bar"><div id="decodeProgressBarAnim"></div></div>
        <span id="decodeProgressText">0%</span>
        <div id="decodeAfterMsg" class="after-msg"></div>
      </div>
      {% if dec_msg and (not step_state or step_state.get('decode')) %}
        <div class="below-status {{dec_status}}">{{ dec_msg }}</div>
        {% if dec_points %}
          <button type="button" class="details-toggle" onclick="toggleDetails('dec-details')">Show/hide decode details</button>
          <div class="points-panel" id="dec-details" style="display:none;">
            <div>Image: {{dec_points.dimension}} | Capacity: {{dec_points.image_bits}} bits</div>
            {% if dec_points.marker_found is defined %}
              <div>Marker found: <b>{{ dec_points.marker_found }}</b>
                {% if dec_points.marker_found %}| At position: {{ dec_points.marker_at }}{% endif %}
              </div>
            {% endif %}
            {% if dec_points.bits_scanned is defined %}
              <div>Bits scanned: {{ dec_points.bits_scanned }}</div>
            {% endif %}
            <div>Status: <b>{{dec_points.status}}</b></div>
          </div>
        {% endif %}
      {% endif %}
      {% if decoded_message %}
        <div class="decode-result"><strong>Secret Message:</strong><br>
          <span id="decodedText">{{ decoded_message }}</span>
          <button type="button" class="clipboard-btn" onclick="copyDecoded()">ğŸ“‹ Copy</button>
        </div>
      {% endif %}
    </form>

  </div>

  <div class="history-panel glassy" aria-label="Session history" role="region" tabindex="0">
    <h3>ğŸ—‚ï¸ Session History
      <a href="/clear_history" class="clear-history" title="Clear all history">[Clear]</a>
    </h3>
    {% if history %}
      <ul>
        {% for item in history %}
          <li>
            <span class="hist-icon">{% if item.image %}ğŸ–¼ï¸{% else %}ğŸ’¬{% endif %}</span>
            <span class="hist-action">{{item.action}}</span>
            {% if not item.image %}<span class="decoded-msg">: {{item.msg}}</span>{% endif %}
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <em>No recent actions this session.</em>
    {% endif %}
    <div class="session-tools">
      <button type="button" onclick="window.location='/export_session';">Export Session</button>
      <label class="import-label">Load Session:
        <input type="file" style="display:none" id="importSession" onchange="importSession(this)">
        <span onclick="document.getElementById('importSession').click();" class="import-btn">Choose File</span>
      </label>
    </div>
  </div>
</div>
</body>
</html>
